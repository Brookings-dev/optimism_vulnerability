<script>
	import { LayerCake, Svg } from 'layercake';
	import { scaleTime, timeParse, groups, min, max, timeFormat } from 'd3';
	import getCategoryName from '$lib/utils/categoryLookup.js';

	import Line from '$lib/components/charts/furniture/Line.svelte';
	import Circle from '$lib/components/charts/furniture/Circle.svelte';
	import Voronoi from '$lib/components/charts/furniture/Voronoi.svelte';
	import AxisX from '$lib/components/charts/furniture/AxisX.svelte';
	import AxisY from '$lib/components/charts/furniture/AxisY.svelte';
	import Tooltip from '$lib/components/interactivity/Tooltip.svelte';

	import data from '$lib/data/inflation_quarter.csv';

	export let height = '400px';

	let categoryData = data
		.filter((d) => d.Category === 'overall')
		.map((d) => {
			d.date = `${d.Month} ${d.Year}`;
			d.name = getCategoryName(d.Category);
			return { ...d };
		});

	let tooltip;
	let parentContainer;

	const getChangeSinceStart = (tooltipData) => {
		const startData = categoryData.find((d) => d.date === '4 2020' && d.name === tooltipData.name);
		const changeSinceStart =
			(+tooltipData['Mentions_per_Million'] - +startData['Mentions_per_Million']) /
			+startData['Mentions_per_Million'];
		return `${changeSinceStart >= 0 ? '+' : ''}${Math.round(changeSinceStart * 100)}%`;
	};
</script>

<div class="w-full" bind:this={parentContainer}>
	<figure class="m-0">
		<figcaption class="m-0 font-display font-bold text-base text-black hidden">Overall</figcaption>
		<div class="w-full" style:height>
			<LayerCake
				padding={{ left: 0, bottom: 0, right: 0, top: 0 }}
				x={(d) => timeParse('%m %Y')(d.date)}
				y="Mentions_per_Million"
				xScale={scaleTime()}
				yDomain={[
					min(categoryData, (d) => +d['Mentions_per_Million']),
					max(categoryData, (d) => +d['Mentions_per_Million'])
				]}
				data={categoryData}
			>
				<Svg>
					<g>
						<AxisX
							baseline
							gridlines={false}
							snapTicks
							ticks={[
								timeParse('%m %Y')('4 2020'),
								timeParse('%m %Y')('4 2021'),
								timeParse('%m %Y')('4 2022')
							]}
							formatTick={(tick) => `Q2 ${timeFormat('%Y')(tick)}`}
						/>
						<AxisY ticks="3" formatTick={() => ''} label={'Review Mentions Per Million Words'} />
					</g>

					<Line
						class="stroke-red"
						areaClass="fill-red opacity-20"
						strokeWidth="3"
						strokeLineCap="round"
					/>

					{#each categoryData as circle}
						<Circle data={circle} class="fill-red" />
					{/each}

					{#if !!tooltip}
						<Circle data={tooltip.detail.data} r="6" class="fill-red stroke-black stroke-[1px]" />
					{/if}

					<Voronoi on:mouseover={(e) => (tooltip = e)} on:mouseout={() => (tooltip = undefined)} />
				</Svg>
			</LayerCake>
		</div>
	</figure>
	{#if !!tooltip}
		<Tooltip hidden={!!tooltip} {parentContainer}>
			<p class="mt-0 mb-2 text-base font-display font-bold text-black">
				{tooltip.detail.data.Quarter}
				{tooltip.detail.data.Year}
			</p>
			<p class="my-0 text-sm font-sans">
				Change since Q2 2020: <b>{getChangeSinceStart(tooltip.detail.data)}</b>
			</p>
		</Tooltip>
	{/if}
</div>
