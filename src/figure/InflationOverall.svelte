<script>
	import { LayerCake, Svg, Html } from 'layercake';
	import { scaleTime, timeParse, timeFormat } from 'd3';
	import getCategoryName from '$lib/utils/categoryLookup.js';
	import Line from '$lib/components/charts/furniture/Line.svelte';
	import Circle from '$lib/components/charts/furniture/Circle.svelte';
	import Voronoi from '$lib/components/charts/furniture/Voronoi.svelte';
	import AxisX from '$lib/components/charts/furniture/AxisX.svelte';
	import AxisY from '$lib/components/charts/furniture/AxisY.svelte';
	import Tooltip from '$lib/components/interactivity/Tooltip.svelte';
	import Annotations from '$lib/components/charts/furniture/Annotations.html.svelte';
	import Arrows from '$lib/components/charts/furniture/Arrows.svelte';
	import ArrowheadMarker from '$lib/components/charts/furniture/ArrowheadMarker.svelte';
	import data from '$lib/data/inflation_quarter.csv';

	export let height = '400px';
	export let containerWidth = 300;
	$: isMobile = containerWidth < 768;

	const categoryData = data
		.filter((d) => d.Category === 'overall')
		.map((d) => {
			d.date = `${d.Month} ${d.Year}`;
			d.name = getCategoryName(d.Category);
			return { ...d };
		});

	let tooltip;
	let parentContainer;

	const getChangeSinceStart = (tooltipData) => {
		const startData = categoryData.find((d) => d.date === '4 2020' && d.name === tooltipData.name);
		const changeSinceStart =
			(+tooltipData['Mentions_per_Million'] - +startData['Mentions_per_Million']) /
			+startData['Mentions_per_Million'];
		return `${changeSinceStart >= 0 ? '+' : ''}${Math.round(changeSinceStart * 100)}%`;
	};

	// annotations
	$: annotationWidth = isMobile ? 100 : 200;
	$: annotations = isMobile
		? [
				{
					text: 'The use of inflationary language on Yelp stayed relatively stagnant in 2020.',
					top: '30%',
					left: '25%',
					arrows: [
						{
							clockwise: false, // true or false, defaults to true
							source: {
								anchor: 'left-middle', // can be `{left, middle, right},{top-middle-bottom}`
								dx: -5,
								dy: 10
							},
							target: {
								x: '18%',
								y: '68%'
							}
						}
					]
				},
				{
					text: 'But has continued to grow in 2021 and 2022, increasing every quarter.',
					top: '50%',
					left: '65%',
					arrows: [
						{
							clockwise: false,
							source: {
								anchor: 'right-bottom',
								dy: -20,
								dx: 5
							},
							target: {
								x: '88%',
								y: '25%'
							}
						}
					]
				}
		  ]
		: [
				{
					text: 'The use of inflationary language on Yelp stayed relatively stagnant in 2020.',
					top: '35%',
					left: '23%',
					arrows: [
						{
							clockwise: false, // true or false, defaults to true
							source: {
								anchor: 'left-top', // can be `{left, middle, right},{top-middle-bottom}`
								dx: -20,
								dy: 40
							},
							target: {
								x: '18%',
								y: '68%'
							}
						}
					]
				},
				{
					text: 'But has continued to grow in 2021 and 2022, increasing every quarter.',
					top: '60%',
					right: '10%',
					arrows: [
						{
							clockwise: false,
							source: {
								anchor: 'right-bottom',
								dy: -40,
								dx: 5
							},
							target: {
								x: '93%',
								y: '20%'
							}
						}
					]
				}
		  ];
</script>

<svelte:window on:scroll={() => (tooltip = undefined)} />

<div
	class="w-full chart-container"
	bind:this={parentContainer}
	bind:clientWidth={containerWidth}
	on:mouseout={() => (tooltip = undefined)}
	on:blur={() => (tooltip = undefined)}
>
	<figure class="m-0">
		<figcaption class="m-0 font-display font-bold text-base text-black hidden">Overall</figcaption>
		<div class="w-full" style:height>
			<LayerCake
				padding={{ left: 0, bottom: 20, right: 0, top: 20 }}
				x={(d) => timeParse('%m %Y')(d.date)}
				y={'Mentions_per_Million'}
				xScale={scaleTime()}
				yDomain={[160, 250]}
				data={categoryData}
			>
				<Svg>
					<g>
						<AxisX
							gridlines={false}
							snapTicks
							ticks={[
								timeParse('%m %Y')('4 2020'),
								timeParse('%m %Y')('4 2021'),
								timeParse('%m %Y')('4 2022')
							]}
							formatTick={(tick) => `Q2 ${timeFormat('%Y')(tick)}`}
						/>
						<AxisY
							ticks={[160, 190, 220, 250]}
							formatTick={() => ''}
							label={'Review Mentions Per Million Words'}
						/>
					</g>

					<Line
						class="stroke-red"
						areaClass="fill-red opacity-20"
						strokeWidth="3"
						strokeLineCap="round"
					/>

					{#each categoryData as circle}
						<Circle data={circle} class="fill-red" />
					{/each}

					{#if !!tooltip}
						<Circle data={tooltip.detail.data} r="6" class="fill-red stroke-black stroke-[1px]" />
					{/if}

					<Voronoi
						on:mouseover={(e) => (tooltip = e)}
						on:focus={(e) => (tooltip = e)}
						on:mouseout={() => (tooltip = undefined)}
						on:blur={() => (tooltip = undefined)}
					/>
				</Svg>
				<Html pointerEvents={false}>
					<Annotations {annotations} {annotationWidth} />
				</Html>

				<Svg pointerEvents={false}>
					<svelte:fragment slot="defs">
						<ArrowheadMarker />
					</svelte:fragment>
					<Arrows {annotations} />
				</Svg>
			</LayerCake>
		</div>
	</figure>
	{#if !!tooltip}
		<Tooltip {parentContainer}>
			<p class="mt-0 mb-2 text-base font-display font-bold text-black">
				{tooltip.detail.data.Quarter}
				{tooltip.detail.data.Year}
			</p>
			<p class="my-0 text-sm font-sans">
				Change since Q2 2020: <b>{getChangeSinceStart(tooltip.detail.data)}</b>
			</p>
		</Tooltip>
	{/if}
</div>
