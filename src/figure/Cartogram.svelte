<script>
	import { extent, format, scaleQuantile } from 'd3';
	import Select from 'svelte-select';
	import 'svelte-select/tailwind.css';
	import states from '$lib/data/cartography/states.json';
	import Tooltip from '$lib/components/interactivity/Tooltip.svelte';
	import getCategoryName from '$lib/utils/categoryLookup';
	import colors from '$lib/utils/colors.json';
	import { onMount } from 'svelte';
	import Legend from '$lib/components/charts/Legend.svelte';
	import Dropdown from '$lib/components/charts/Dropdown.svelte';
	import { parsedStates, selectedFirst, selectedSecond, selectedState } from '$lib/stores.js';

	let containerWidth;
	let size = 25;
	let firstMetricActive = true;

	$: isMobile = containerWidth < 768;

	let options;
	$: options = Object.values(parsedStates);
	let optionsKeys = [];
	$: optionsKeys = Object.keys(options[0])
		.filter((d) => d !== 'optimism' && d !== 'state')
		.map((metric) => ({
			label: getCategoryName(metric).dropdown,
			value: metric
		}));

	let optionsOptimism = ['optimism', 'None'].map((metric) => ({
		label: metric == 'optimism' ? getCategoryName(metric).dropdown : metric,
		value: metric
	}));

	let selectedExtentFirst = [];
	$: selectedExtentFirst = extent(
		Object.entries(parsedStates),
		([key, value]) => +value[$selectedFirst]
	);
	let selectedExtentSecond = [];
	$: selectedExtentSecond = extent(
		Object.entries(parsedStates),
		([key, value]) => +value[$selectedSecond]
	);

	let colorsBlue = [colors.blue.light, colors.blue.DEFAULT];
	let colorsYellow = [colors.yellow.light, colors.yellow.DEFAULT];

	let colorsBlueLegend = [colors.blue.DEFAULT, colors.blue.light];
	let colorsYellowLegend = [colors.yellow.DEFAULT, colors.yellow.light];

	$: colorScaleBlue = scaleQuantile().domain(selectedExtentSecond).range(colorsBlue);
	$: colorScaleYellow = scaleQuantile().domain(selectedExtentFirst).range(colorsYellow);

	$: $selectedFirst == 'None' ? (firstMetricActive = false) : (firstMetricActive = true);

	let tooltip;
	const mouseover = (e) => (tooltip = e);
	const mouseout = () => (tooltip = undefined);

	let mounted;
	onMount(() => (mounted = true));

	let valueFirst = {
		label: getCategoryName($selectedFirst).dropdown,
		value: $selectedFirst
	};
	let valueSecond = {
		label: getCategoryName($selectedSecond).dropdown,
		value: $selectedSecond
	};

	let handle = () => {
		$selectedSecond = valueSecond.value;
		$selectedFirst = valueFirst.value;
	};

	const formatSecondValue = (d) =>
		$selectedSecond == 'income'
			? '$' + format(',')(format('.2f')(d))
			: format(',')(format('.2f')(d));
</script>

<svelte:window
	bind:innerWidth={containerWidth}
	on:scroll={() => {
		if (tooltip) tooltip = undefined;
	}}
/>
{#if mounted}
	<div class="flex md:flex-row flex-col my-12 gap-5 justify-between">
		<Dropdown title="U.S. map variable 1:">
			<Select
				class="m-auto md:mb-auto mb-5 border-b-2 border-b-[{colors.gray
					.dark}] border-t-transparent border-x-transparent text-[{colors.gray.dark}] font-sans"
				items={optionsOptimism}
				clearable={false}
				bind:value={valueFirst}
				showChevron={true}
				searchable={false}
				on:change={handle}
				--width={isMobile ? '300px' : '350px'}
				--border-radius="none"
				--item-hover-bg={colors.gray.light}
				--item-is-active-bg={colors.gray.DEFAULT}
				--chevron-icon-width="20px"
				--selected-item-color={colors.gray.dark}
			/></Dropdown
		>
		<Dropdown title="U.S. map variable 2:">
			<Select
				class="m-auto md:mb-auto mb-5 border-b-2 border-b-[{colors.gray
					.dark}] border-t-transparent border-x-transparent text-[{colors.gray.dark}] font-sans"
				items={optionsKeys}
				clearable={false}
				bind:value={valueSecond}
				showChevron={true}
				searchable={false}
				on:change={handle}
				--width={isMobile ? '300px' : '350px'}
				--border-radius="none"
				--item-hover-bg={colors.gray.light}
				--item-is-active-bg={colors.gray.DEFAULT}
				--chevron-icon-width="20px"
				--group-title-font-weight="600"
			/></Dropdown
		>
	</div>
	<figure>
		<div class="grid grid-cols-8 grid-rows-11 md:grid-cols-11 md:grid-rows-8 gap-1">
			<!-- an unfilled tile to track sizes -->
			<div
				bind:clientWidth={size}
				style:grid-area="2 / 1 / auto / auto"
				style:height="{size}px"
				aria-hidden="true"
			/>
			{#each states as state (state.postal)}
				{@const stateData = parsedStates[state.postal]}
				<!-- {@const row = isMobile ? 12 - state.coords.x : state.coords.y}
				{@const col = isMobile ? state.coords.y : state.coords.x} -->
				{@const row = state.coords.y}
				{@const col = state.coords.x}
				<div
					id="tile-{state.postal.toLowerCase()}"
					class="relative font-sans overflow-hidden flex flex-col justify-center items-center pointer-events-auto rounded-sm p-1 bg-opacity-100"
					style:grid-area="{row} / {col} / auto / auto"
					style:height="{size}px"
					style:background-color={stateData[$selectedFirst] == 'NA' ||
					stateData[$selectedFirst] == 0
						? colors.gray.light
						: colorScaleYellow(stateData[$selectedFirst])}
					style:mix-blend-mode={$selectedFirst == 'optimism' ? 'darken' : 'normal'}
					on:mouseenter={() => mouseover({ state, ...stateData })}
					on:focus={() => mouseover({ state, ...stateData })}
					on:mouseleave={() => mouseout({ state, ...stateData })}
					on:blur={() => mouseout({ state, ...stateData })}
				/>
				<div
					id="tile-{state.postal.toLowerCase()}"
					class="relative overflow-hidden flex flex-col justify-center items-center pointer-events-auto rounded-sm p-1 bg-opacity-100"
					style:grid-area="{row} / {col} / auto / auto"
					style:height="{size}px"
					style:background-color={stateData[$selectedSecond] == 'NA' ||
					stateData[$selectedSecond] == 0
						? colors.gray.light
						: colorScaleBlue(stateData[$selectedSecond])}
					style:mix-blend-mode={$selectedFirst == 'optimism' ? 'darken' : 'normal'}
					style:border={state.postal == $selectedState ? '4px dashed white' : 'none'}
					style:filter={state.postal == $selectedState
						? 'drop-shadow(3px 5px 2px rgb(0 0 0 / 0.4))'
						: ''}
					on:mouseenter={() => mouseover({ state, ...stateData })}
					on:focus={() => mouseover({ state, ...stateData })}
					on:mouseleave={() => mouseout({ state, ...stateData })}
					on:blur={() => mouseout({ state, ...stateData })}
				/>
				<div
					class="relative overflow-hidden flex flex-col justify-center items-center pointer-events-auto rounded-sm p-1 bg-opacity-100"
					style:grid-area="{row} / {col} / auto / auto"
					style:height="{size}px"
					style:background-color="none"
					style:border={state.postal == $selectedState ? '4px dashed white' : 'none'}
					style:filter={state.postal == $selectedState
						? 'drop-shadow(3px 5px 2px rgb(0 0 0 / 0.4))'
						: ''}
					on:mouseenter={() => mouseover({ state, ...stateData })}
					on:focus={() => mouseover({ state, ...stateData })}
					on:mouseleave={() => mouseout({ state, ...stateData })}
					on:blur={() => mouseout({ state, ...stateData })}
				>
					<p
						style:grid-area="{row} / {col} / auto / auto"
						class="pointer-events-none justify-center items-center text-sm lg:text-md font-display font-bold text-center"
						style:color={colors.white.DEFAULT}
						style:filter="drop-shadow(3px 5px 2px rgb(0 0 0 / 0.4))"
					>
						{state.postal}
					</p>
				</div>
			{/each}

			{#if !!tooltip}
				<Tooltip>
					<p class="mt-0 mb-1 text-md font-semibold">
						{tooltip.state.full}
					</p>
					<p class="mt-0 text-sm text-gray">
						{$selectedFirst == 'None' ? '' : getCategoryName($selectedFirst).tooltip}
					</p>
					<p class="mt-0 mb-1 text-sm font-bold">
						{$selectedFirst == 'None'
							? ''
							: tooltip[$selectedFirst] == 'NA'
							? 'Data unavailable'
							: format('.4f')(tooltip[$selectedFirst])}
					</p>
					<p class="mt-0 text-sm text-gray">
						{getCategoryName($selectedSecond).tooltip}
					</p>
					<p class="mt-0 mb-1 text-sm font-bold">
						{tooltip[$selectedSecond] == 'NA'
							? 'Data unavailable'
							: formatSecondValue(tooltip[$selectedSecond])}
					</p>
				</Tooltip>
			{/if}
		</div>
	</figure>
	<Legend
		{firstMetricActive}
		legendBackground={colors.gray.light}
		firstColorArray={colorsBlueLegend}
		secondColorArray={colorsYellowLegend}
		stroke={colors.gray.dark}
		firstLabel={getCategoryName($selectedFirst).legend}
		secondLabel={getCategoryName($selectedSecond).legend}
	/>
{/if}
