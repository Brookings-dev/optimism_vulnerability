<script>
	import { extent, format, scaleQuantile } from 'd3';
	import Select from 'svelte-select';
	import 'svelte-select/tailwind.css';
	import states from '$lib/data/cartography/states.json';
	import Tooltip from '$lib/components/interactivity/Tooltip.svelte';
	import getCategoryName from '$lib/utils/categoryLookup';
	import colors from '$lib/utils/colors.json';
	import { onMount } from 'svelte';
	import Legend from '$lib/components/charts/Legend.svelte';
	import Dropdown from '$lib/components/charts/Dropdown.svelte';
	import {
		parsedStates,
		selectedFirst,
		selectedSecond,
		selectedState,
		selectedCounty
	} from '$lib/stores.js';

	let containerWidth;
	let size = 25;
	let firstMetricActive = true;
	let secondMetricActive = true;

	$: isMobile = containerWidth < 640;

	let options;
	$: options = Object.values(parsedStates);
	let optionsKeys = [];
	$: optionsKeys = Object.keys(options[0])
		.filter((d) => d !== 'optimism' && d !== 'state')
		.map((metric) => ({
			label: getCategoryName(metric).dropdown,
			value: metric
		}));
	let optionsMetrics = [];
	$: optionsMetrics = [
		...optionsKeys,
		{ label: 'None', value: 'None', selectable: $selectedFirst == 'None' ? false : true }
	];
	let optionsOptimism = [];
	$: optionsOptimism = [
		{
			label: getCategoryName('optimism').dropdown,
			value: 'optimism',
			selectable: true
		},
		{ label: 'None', value: 'None', selectable: $selectedSecond == 'None' ? false : true }
	];

	let selectedExtentFirst = [];
	$: selectedExtentFirst = extent(
		Object.entries(parsedStates),
		([key, value]) => +value[$selectedFirst]
	);
	let selectedExtentSecond = [];
	$: selectedExtentSecond = extent(
		Object.entries(parsedStates),
		([key, value]) => +value[$selectedSecond]
	);

	let colorsBlue = [colors.blue.light, colors.blue.DEFAULT];
	let colorsYellow = [colors.yellow.light, colors.yellow.DEFAULT];

	let colorsBlueLegend = [colors.blue.DEFAULT, colors.blue.light];
	let colorsYellowLegend = [colors.yellow.DEFAULT, colors.yellow.light];

	$: colorScaleBlue = scaleQuantile().domain(selectedExtentSecond).range(colorsBlue);
	$: colorScaleYellow = scaleQuantile().domain(selectedExtentFirst).range(colorsYellow);

	$: $selectedFirst == 'None' ? (firstMetricActive = false) : (firstMetricActive = true);
	$: $selectedSecond == 'None' ? (secondMetricActive = false) : (secondMetricActive = true);

	let tooltip;
	const mouseover = (e) => (tooltip = e);
	const mouseout = () => (tooltip = undefined);

	let click;
	$: clicked = (e) => {
		click = e;
		$selectedState = click.state.postal;
		$selectedCounty = null;
	};

	let mounted;
	onMount(() => (mounted = true));

	let valueFirst = {
		label: getCategoryName($selectedFirst).dropdown,
		value: $selectedFirst
	};
	let valueSecond = {
		label: getCategoryName($selectedSecond).dropdown,
		value: $selectedSecond
	};

	let formatValue = (d) =>
		$selectedSecond == 'income'
			? '$' + format(',')(format('.2f')(d))
			: format(',')(format('.2f')(d));

	let handle = () => {
		$selectedSecond = valueSecond.value;
		$selectedFirst = valueFirst.value;
	};
</script>

<svelte:window
	bind:innerWidth={containerWidth}
	on:scroll={() => {
		if (tooltip) tooltip = undefined;
	}}
/>
{#if mounted}
	<div class="flex md:flex-row flex-col my-12 gap-5 justify-between items-center">
		<Dropdown title="U.S. map variable 1:">
			<Select
				class="m-auto md:mb-auto mb-5 border-b-2 border-b-[{colors.gray
					.dark}] border-t-transparent border-x-transparent text-[{colors.gray
					.dark}] font-sans bg-transparent"
				items={optionsOptimism}
				clearable={false}
				searchable={false}
				bind:value={valueFirst}
				showChevron={true}
				on:change={handle}
				--width={isMobile ? '250px' : '325px'}
				--border-radius="none"
				--item-hover-bg={colors.gray.light}
				--item-is-active-bg={colors.gray.DEFAULT}
				--chevron-icon-width="20px"
				--selected-item-color={colors.gray.dark}
			/></Dropdown
		>
		<Dropdown title="U.S. map variable 2:">
			<Select
				class="m-auto md:mb-auto mb-5 border-b-2 border-b-[{colors.gray
					.dark}] border-t-transparent border-x-transparent text-[{colors.gray
					.dark}] font-sans bg-transparent"
				items={optionsMetrics}
				clearable={false}
				bind:value={valueSecond}
				showChevron={true}
				searchable={false}
				on:change={handle}
				--width={isMobile ? '250px' : '325px'}
				--border-radius="none"
				--item-hover-bg={colors.gray.light}
				--item-is-active-bg={colors.gray.DEFAULT}
				--chevron-icon-width="20px"
				--group-title-font-weight="600"
			/></Dropdown
		>
	</div>
	<figure>
		<div class="grid grid-cols-11 grid-rows-8 gap-1">
			<!-- <div class="grid grid-cols-8 grid-rows-11 sm:grid-cols-11 sm:grid-rows-8 gap-1"> -->

			<!-- an unfilled tile to track sizes -->
			<div
				bind:clientWidth={size}
				style:grid-area="2 / 1 / auto / auto"
				style:height="{size}px"
				aria-hidden="true"
			/>
			{#each states as state (state.postal)}
				{@const stateData = parsedStates[state.postal]}
				{@const row = state.coords.y}
				{@const col = state.coords.x}
				<!-- {@const row = isMobile ? 12 - state.coords.x : state.coords.y}
				{@const col = isMobile ? state.coords.y : state.coords.x} -->
				{#if firstMetricActive}
					<div
						id="tile-{state.postal.toLowerCase()}"
						class="relative overflow-hidden flex justify-center items-center pointer-events-auto rounded-sm p-1 bg-opacity-100"
						style:grid-area="{row} / {col} / auto / auto"
						style:height="{size}px"
						style:background-color={stateData[$selectedFirst] == 'NA' ||
						stateData[$selectedFirst] == 0
							? colors.gray.light
							: colorScaleYellow(stateData[$selectedFirst])}
						style:mix-blend-mode={$selectedFirst == 'optimism' ? 'darken' : 'normal'}
					/>
				{/if}
				{#if secondMetricActive}
					<div
						id="tile-{state.postal.toLowerCase()}"
						class="relative overflow-hidden flex justify-center items-center pointer-events-auto rounded-sm p-1 bg-opacity-100"
						style:grid-area="{row} / {col} / auto / auto"
						style:height="{size}px"
						style:background-color={stateData[$selectedSecond] == 'NA' ||
						stateData[$selectedSecond] == 0
							? colors.gray.light
							: colorScaleBlue(stateData[$selectedSecond])}
						style:mix-blend-mode={$selectedFirst == 'optimism' ? 'darken' : 'normal'}
						style:filter={state.postal == $selectedState
							? 'drop-shadow(3px 5px 2px rgb(0 0 0 / 0.4))'
							: ''}
					/>
				{/if}
				<div
					class="relative overflow-hidden flex justify-center items-center pointer-events-auto rounded-sm p-1 bg-opacity-100"
					style:grid-area="{row} / {col} / auto / auto"
					style:height="{size}px"
					style:background-color="none"
					style:border={state.postal == $selectedState && !isMobile
						? '3px dashed white'
						: state.postal == $selectedState && isMobile
						? '1.5px dashed white'
						: 'none'}
					style:filter={state.postal == $selectedState
						? 'drop-shadow(2px 3px 2px rgb(0 0 0 / 0.4))'
						: ''}
					on:mouseenter={() => mouseover({ state, ...stateData })}
					on:focus={() => mouseover({ state, ...stateData })}
					on:mouseleave={() => mouseout({ state, ...stateData })}
					on:blur={() => mouseout({ state, ...stateData })}
					on:click={() => clicked({ state, ...stateData })}
				>
					<p
						style:grid-area="{row} / {col} / auto / auto"
						class="pointer-events-none justify-center items-center font-bold text-center"
						style:color={colors.white.DEFAULT}
						style:font-size={isMobile ? '9px' : '14px'}
						style:filter="drop-shadow(2px 2px 2px rgb(0 0 0 / 0.4))"
					>
						{state.postal}
					</p>
				</div>
			{/each}

			{#if !!tooltip}
				<Tooltip>
					<p class="mt-0 mb-1 text-md font-semibold">
						{tooltip.state.full}
					</p>
					<p class="mt-0 text-sm text-gray">
						{$selectedFirst == 'None' ? '' : getCategoryName($selectedFirst).tooltip}
					</p>
					<p class="mt-0 mb-1 text-sm font-bold">
						{$selectedFirst == 'None'
							? ''
							: tooltip[$selectedFirst] == 'NA'
							? 'Data unavailable'
							: format('.4f')(tooltip[$selectedFirst])}
					</p>
					<p class="mt-0 text-sm text-gray">
						{$selectedSecond == 'None' ? '' : getCategoryName($selectedSecond).tooltip}
					</p>
					<p class="mt-0 mb-1 text-sm font-bold">
						{$selectedSecond == 'None'
							? ''
							: tooltip[$selectedSecond] == 'NA'
							? 'Data unavailable'
							: formatValue(tooltip[$selectedSecond])}
					</p>
				</Tooltip>
			{/if}
		</div>
	</figure>
	<div class="relative">
		<Legend
			{firstMetricActive}
			{secondMetricActive}
			legendBackground={colors.gray.light}
			firstColorArray={colorsBlueLegend}
			secondColorArray={colorsYellowLegend}
			stroke={colors.gray.dark}
			firstLabel={getCategoryName($selectedFirst).legend}
			secondLabel={getCategoryName($selectedSecond).legend}
		/>
	</div>
{/if}
