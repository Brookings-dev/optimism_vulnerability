<script>
	import { LayerCake, Svg, Html } from 'layercake';
	import { rollups, descending } from 'd3';
	import stateAbbrs from '$lib/data/helpers/stateAbbrs.js';
	import states from '$lib/data/cartography/states.json';
	import Annotations from '$lib/components/charts/furniture/Annotations.html.svelte';
	import Arrows from '$lib/components/charts/furniture/Arrows.svelte';
	import ArrowheadMarker from '$lib/components/charts/furniture/ArrowheadMarker.svelte';
	import data from '$lib/data/category_inflation_state.csv';
	import Tooltip from '$lib/components/interactivity/Tooltip.svelte';
	import getCategoryName from '$lib/utils/categoryLookup.js';
	import { onMount } from 'svelte';

	let size = 25;
	let containerWidth = 300;
	$: isMobile = containerWidth < 768;

	let categories = [
		'shopping',
		'active',
		'arts',
		'auto',
		'beautysvc',
		'education',
		'eventservices',
		'financialservices',
		'food',
		'health',
		'homeservices',
		'hotelstravel',
		'localflavor',
		'localservices',
		'nightlife',
		'pets',
		'professional',
		'restaurants',
		'publicservicesgovt'
	];

	let categoryData = data
		.filter((d) => categories.indexOf(d.Alias) > -2)
		.map((d) => {
			d.name = getCategoryName(d.Alias);
			return { ...d };
		});

	const parsedStates = Object.fromEntries(
		rollups(
			categoryData,
			(state) => {
				const sorted = state.sort((a, b) => descending(+a['2022 vs 2021'], +b['2022 vs 2021']));
				const maxVal = sorted[0];
				const secondVal = state.length > 1 ? sorted[1] : 'undefined';
				const thirdVal = state.length > 2 ? sorted[2] : 'undefined';
				return {
					value: maxVal['2022 vs 2021'],
					key: maxVal.Alias,
					category: maxVal.name,
					value2: secondVal['2022 vs 2021'],
					key2: secondVal.Alias,
					category2: secondVal.name,
					value3: thirdVal['2022 vs 2021'],
					key3: thirdVal.Alias,
					category3: thirdVal.name
				};
			},
			(d) => stateAbbrs[d.State]
		)
	);

	let tooltip;
	const mouseover = (e) => (tooltip = e);
	const mouseout = () => (tooltip = undefined);
	const formatValue = (d) => `+${Math.round(d)}%`;

	// annotations
	// see https://layercake.graphics/example/Column
	$: annotations = isMobile
		? [
				{
					text: 'In Connecticut, beauty services had the highest increase in inflationary language in reviews.',
					top: '-25%',
					left: '125%',
					arrows: [
						{
							clockwise: false, // true or false, defaults to true
							source: {
								anchor: 'left-top', // can be `{left, middle, right},{top-middle-bottom}`
								dx: -6,
								dy: 26
							},
							target: {
								x: '60%',
								y: '95%'
							}
						}
					]
				}
		  ]
		: [
				{
					text: 'In Alaska, bars and nightlife businesses had the highest increase in inflationary language in reviews.',
					top: '20%',
					left: '75%',
					arrows: [
						{
							clockwise: true, // true or false, defaults to true
							source: {
								anchor: 'left-top', // can be `{left, middle, right},{top-middle-bottom}`
								dx: 5,
								dy: 50
							},
							target: {
								x: '-20%',
								y: '112%'
							}
						}
					]
				}
		  ];

	$: annotationWidth = isMobile ? 175 : 300;

	let mounted;
	onMount(() => (mounted = true));
</script>

<svelte:window
	on:scroll={() => {
		if (tooltip) tooltip = undefined;
	}}
/>

<figure class="content-well-lg">
	<div
		class="grid grid-cols-8 grid-rows-11 md:grid-cols-11 md:grid-rows-8 gap-1.5 chart-container"
		bind:clientWidth={containerWidth}
	>
		<!-- an unfilled tile to track sizes -->
		<div
			bind:clientWidth={size}
			style:grid-area="2 / 1 / auto / auto"
			style:height="{size}px"
			aria-hidden="true"
		/>
		{#each states as state (state.postal)}
			{@const stateData = parsedStates[state.full]}
			{@const row = isMobile ? 12 - state.coords.x : state.coords.y}
			{@const col = isMobile ? state.coords.y : state.coords.x}
			<a
				id="tile-{state.postal.toLowerCase()}"
				class="relative overflow-hidden flex flex-col justify-center items-center pointer-events-auto bg-red-light border-solid border-[.5px] border-red rounded-sm p-1 hover:bg-yellow hover:border-black"
				style:grid-area="{row} / {col} / auto / auto"
				style:height="{size}px"
				on:mouseenter={() => mouseover({ state, ...stateData })}
				on:focus={() => mouseover({ state, ...stateData })}
				on:mouseleave={() => mouseout({ state, ...stateData })}
				on:blur={() => mouseout({ state, ...stateData })}
			>
				<p
					class="text-tiny sm:text-xs lg:text-sm font-display text-black font-bold p-0 m-0 mb-0 text-center text-primary"
				>
					{state.postal}
				</p>
				<p
					class="text-[7px] sm:text-xs lg:text-sm font-sans text-black p-0 m-0 text-center text-primary"
				>
					{stateData.category}
				</p>
			</a>
		{/each}

		{#if mounted}
			<LayerCake>
				<Html pointerEvents={false}>
					<Annotations {annotations} {annotationWidth} />
				</Html>

				<Svg pointerEvents={false}>
					<svelte:fragment slot="defs">
						<ArrowheadMarker />
					</svelte:fragment>
					<Arrows {annotations} />
				</Svg>
			</LayerCake>
		{/if}

		{#if !!tooltip}
			<Tooltip>
				<p class="mt-0 mb-1 text-base font-display font-bold text-black">
					{tooltip.state.full}
				</p>
				{#each [[tooltip.category, tooltip.value], [tooltip.category2, tooltip.value2], [tooltip.category3, tooltip.value3]] as [category, value]}
					{#if category && value > 0}
						<p class="my-0 text-sm font-sans">
							{category}: <b>{formatValue(value)}</b>
						</p>
					{/if}
				{/each}
			</Tooltip>
		{/if}
	</div>
</figure>
