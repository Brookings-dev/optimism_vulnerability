<script>
	// TODO: give data props to pass to tie in values to tile
	// TODO: generalize design + classes to pass
	import { LayerCake, Svg, Html } from 'layercake';
	import { rollups, descending } from 'd3';
	import stateAbbrs from '$lib/data/cartography/states.json';
	import states from '$lib/data/cartography/states.json';
	import Annotations from '$lib/components/charts/furniture/Annotations.html.svelte';
	import Arrows from '$lib/components/charts/furniture/Arrows.svelte';
	import ArrowheadMarker from '$lib/components/charts/furniture/ArrowheadMarker.svelte';
	import data from '$lib/data/category_inflation_state.csv';
	import Tooltip from '$lib/components/interactivity/Tooltip.svelte';
	import getCategoryName from '$lib/utils/categoryLookup.js';

	const stateIdxMap = new Map(states.map((state) => [state.idx, state]));
	// console.log(stateIdxMap);
	let size = 25;
	let containerWidth = 300;
	$: isMobile = containerWidth < 768;

	let categories = [
		'shopping',
		'active',
		'arts',
		'auto',
		'beautysvc',
		'education',
		'eventservices',
		'financialservices',
		'food',
		'health',
		'homeservices',
		'hotelstravel',
		'localflavor',
		'localservices',
		'nightlife',
		'pets',
		'professional',
		'restaurants',
		'publicservicesgovt'
	];

	let categoryData = data
		.filter((d) => categories.indexOf(d.Alias) > -2)
		.map((d) => {
			d.name = getCategoryName(d.Alias);
			return { ...d };
		});

	let tooltip;
	let parentContainer;
	let wrapperEl;

	const mouseover = (e) => {
		tooltip = e;
	};

	const mouseout = () => {
		tooltip = undefined;
	};
	const formatValue = (d) => {
		return `+${Math.round(d)}%`;
	};

	const parsed = rollups(
		categoryData,
		(state) => {
			const maxVal = state.sort((a, b) => descending(+a['2022 vs 2021'], +b['2022 vs 2021']))[0];
			const secondVal =
				state.length > 1
					? state.sort((a, b) => descending(+a['2022 vs 2021'], +b['2022 vs 2021']))[1]
					: 'undefined';
			const thirdVal =
				state.length > 2
					? state.sort((a, b) => descending(+a['2022 vs 2021'], +b['2022 vs 2021']))[2]
					: 'undefined';

			return {
				value: maxVal['2022 vs 2021'],
				key: maxVal.Alias,
				label: maxVal.name,
				value2: secondVal['2022 vs 2021'],
				key2: secondVal.Alias,
				label2: secondVal.name,
				value3: thirdVal['2022 vs 2021'],
				key3: thirdVal.Alias,
				label3: thirdVal.name
			};
		},
		(d) => d.State
	);

	const parsedStates = parsed.map((state) => {
		// console.log(state[0]);
		return {
			state: stateAbbrs.find((d) => d.postal === state[0]).full,
			...state[1]
		};
	});

	// code for annotations

	const annotationsDesktop = [
		{
			text: 'In Alaska, the category with the highest increase in inflationary language in reviews was nightlife businesses.',
			top: '20%',
			left: '75%',
			arrows: [
				{
					clockwise: true, // true or false, defaults to true
					source: {
						anchor: 'left-top', // can be `{left, middle, right},{top-middle-bottom}`
						dx: 5,
						dy: 60
					},
					target: {
						x: '-20%',
						y: '112%'
					}
				}
			]
		}
	];

	const annotationsMobile = [
		{
			text: 'In Connecticut, the category with the highest increase in inflationary language in reviews was beauty businesses.',
			top: '-15%',
			left: '125%',
			arrows: [
				{
					clockwise: false, // true or false, defaults to true
					source: {
						anchor: 'left-top', // can be `{left, middle, right},{top-middle-bottom}`
						dx: -5,
						dy: 15
					},
					target: {
						x: '60%',
						y: '95%'
					}
				}
			]
		}
	];

	$: annotations = isMobile ? annotationsMobile : annotationsDesktop;
	$: annotationWidth = isMobile ? 175 : 300;
</script>

<figure class="content-well-lg">
	<div
		class="grid grid-cols-8 grid-rows-11 md:grid-cols-11 md:grid-rows-8 gap-1.5 chart-container"
		bind:clientWidth={containerWidth}
		bind:this={wrapperEl}
	>
		<!-- an unfilled tile to track sizes -->
		<div
			bind:clientWidth={size}
			style:grid-area="2 / 1 / auto / auto"
			style:height="{size}px"
			aria-hidden="true"
		/>
		{#each states as thisState (thisState.postal)}
			{@const statePostal = thisState.postal.toLowerCase()}
			{@const {
				label: category,
				value,
				label2: category2,
				value2,
				label3: category3,
				value3
			} = parsedStates.find((d) => d.state === thisState.full)}
			{@const row = isMobile ? 12 - thisState.coords.x : thisState.coords.y}
			{@const col = isMobile ? thisState.coords.y : thisState.coords.x}
			<a
				id="tile-{statePostal}"
				class="relative overflow-hidden flex flex-col justify-center items-center pointer-events-auto bg-red-light border-solid border-[.5px] border-red rounded-sm hover:bg-yellow hover:border-black"
				style:grid-area="{row} / {col} / auto / auto"
				style:height="{size}px"
				on:mouseenter={() =>
					mouseover({ thisState, value, category, value2, category2, value3, category3 })}
				on:mouseleave={() =>
					mouseout({ thisState, value, category, value2, category2, value3, category3 })}
			>
				<p
					class="text-tiny sm:text-xs lg:text-sm font-display text-black font-bold p-0 m-0 mb-0 text-center text-primary"
				>
					{thisState.postal}
				</p>
				<p
					class="text-tiny sm:text-xs lg:text-sm font-sans text-black p-0 m-0 text-center text-primary"
				>
					{category}
				</p>
				<slot name="tile" />
			</a>
		{/each}

		<LayerCake>
			<Html pointerEvents={false}>
				<Annotations {annotations} {annotationWidth} />
			</Html>

			<Svg pointerEvents={false}>
				<svelte:fragment slot="defs">
					<ArrowheadMarker />
				</svelte:fragment>
				<Arrows {annotations} />
			</Svg>
		</LayerCake>

		{#if !!tooltip}
			<Tooltip hidden={!tooltip} parentContainer={wrapperEl}>
				<p class="mt-0 mb-1 text-base font-display font-bold text-black">
					{tooltip.thisState.full}
				</p>
				<p class="my-0 text-sm font-sans">
					{tooltip.category}: <b>{formatValue(tooltip.value)}</b>
				</p>
				{#if tooltip.category2 && tooltip.value2 > 0}
					<p class="my-0 text-sm font-sans">
						{tooltip.category2}: <b>{formatValue(tooltip.value2)}</b>
					</p>
				{/if}
				{#if tooltip.category3 && tooltip.value3 > 0}
					<p class="my-0 text-sm font-sans">
						{tooltip.category3}: <b>{formatValue(tooltip.value3)}</b>
					</p>
				{/if}
			</Tooltip>
		{/if}
	</div>
</figure>
