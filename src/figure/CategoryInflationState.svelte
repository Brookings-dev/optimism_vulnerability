<script>
	// TODO: give data props to pass to tie in values to tile
	// TODO: generalize design + classes to pass
	import states from '$lib/data/cartography/states.json';
	import data from '$lib/data/category_inflation_state.csv';
	import Tooltip from '$lib/components/interactivity/Tooltip.svelte';

	const stateIdxMap = new Map(states.map((state) => [state.idx, state]));

	let size = 10;

	let tooltip;
	let parentContainer;

	const mouseover = (e) => {
		tooltip = e;
		// console.log(tooltip);
	};

	const mouseout = () => {
		tooltip = undefined;
	};
	const getChangeSinceStart = (d) => {
		return `${Math.round(d)}%`;
	};
</script>

<div class="grid grid-cols-11 grid-rows-[repeat(8,_minmax(0,_1fr))] gap-1.5">
	<!-- 11 * 8 small multiple cartogram -->
	{#each Array.from({ length: 11 * 8 }) as _, i}
		{@const state = stateIdxMap.get(i) || false}
		<!-- first tile that isn't filled -->
		{#if i === 1}
			<div
				bind:clientWidth={size}
				bind:this={parentContainer}
				style:height="{size}px"
				aria-hidden="true"
			/>
		{:else if state}
			{@const { label: category, value } = data.find((d) => d.state === state.full)}
			<div
				on:mouseenter={() => mouseover({ state, value, category })}
				on:mouseleave={() => mouseout({ state, value, category })}
				class="relative overflow-hidden flex flex-col justify-center items-center pointer-events-auto bg-red-light border-solid border-[.5px] border-red rounded-sm"
				style:height="{size}px"
			>
				<p class="text-sm font-display text-black font-bold p-0 m-0 mb-1 text-center text-primary">
					{state.postal}
				</p>
				<p class="text-xs font-sans text-black p-0 m-0 text-center text-primary">{category}</p>
				<slot name="tile" />
			</div>
		{:else}
			<div class="pointer-events-none" style:height="{size}px" aria-hidden="true" />
		{/if}
	{/each}
	{#if !!tooltip}
		<Tooltip hidden={!tooltip} {parentContainer}>
			<p class="mt-0 mb-1 text-base font-display font-bold text-black">
				{tooltip.state.full}
			</p>
			<p class="my-0 text-sm font-sans">
				Category with highest increase: <b>{tooltip.category}</b>
			</p>
			<p class="my-0 text-sm font-sans">
				Change since Q2 2021: <b>{tooltip.value + '%'}</b>
			</p>
		</Tooltip>
	{/if}
</div>
