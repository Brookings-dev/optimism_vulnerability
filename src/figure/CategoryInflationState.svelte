<script>
	// TODO: give data props to pass to tie in values to tile
	// TODO: generalize design + classes to pass
	import { rollups, descending } from 'd3';
	import stateAbbrs from '$lib/data/cartography/states.json';
	import states from '$lib/data/cartography/states.json';
	import data from '$lib/data/category_inflation_state.csv';
	import Tooltip from '$lib/components/interactivity/Tooltip.svelte';
	import getCategoryName from '$lib/utils/categoryLookup.js';

	const stateIdxMap = new Map(states.map((state) => [state.idx, state]));
	// console.log(stateIdxMap);
	let size = 10;
	let borderWidth = 0.5;

	let categories = [
		'shopping',
		'active',
		'arts',
		'auto',
		'beautysvc',
		'education',
		'eventservices',
		'financialservices',
		'food',
		'health',
		'homeservices',
		'hotelstravel',
		'localflavor',
		'localservices',
		'nightlife',
		'pets',
		'professional',
		'restaurants',
		'publicservicesgovt'
	];

	let categoryData = data
		.filter((d) => categories.indexOf(d.Alias) > -2)
		.map((d) => {
			d.name = getCategoryName(d.Alias);
			return { ...d };
		});

	let tooltip;
	let parentContainer;

	const mouseover = (e) => {
		tooltip = e;
	};

	const mouseout = () => {
		tooltip = undefined;
	};
	const formatValue = (d) => {
		return `+${Math.round(d * 10) / 10}%`;
	};

	const parsed = rollups(
		categoryData,
		(state) => {
			const maxVal = state.sort((a, b) => descending(+a['2022 vs 2021'], +b['2022 vs 2021']))[0];
			const secondVal =
				state.length > 1
					? state.sort((a, b) => descending(+a['2022 vs 2021'], +b['2022 vs 2021']))[1]
					: 'undefined';
			const thirdVal =
				state.length > 2
					? state.sort((a, b) => descending(+a['2022 vs 2021'], +b['2022 vs 2021']))[2]
					: 'undefined';

			return {
				value: maxVal['2022 vs 2021'],
				key: maxVal.Alias,
				label: maxVal.name,
				value2: secondVal['2022 vs 2021'],
				key2: secondVal.Alias,
				label2: secondVal.name,
				value3: thirdVal['2022 vs 2021'],
				key3: thirdVal.Alias,
				label3: thirdVal.name
			};
		},
		(d) => d.State
	);
	const parsedStates = parsed.map((state) => {
		// console.log(state[0]);
		return {
			state: stateAbbrs.find((d) => d.postal === state[0]).full,
			...state[1]
		};
	});
</script>

<div class="grid grid-cols-11 grid-rows-[repeat(8,_minmax(0,_1fr))] gap-1.5">
	<!-- 11 * 8 small multiple cartogram -->
	{#each Array.from({ length: 11 * 8 }) as _, i}
		{@const thisState = stateIdxMap.get(i) || false}
		{#if i === 1}
			<div
				bind:clientWidth={size}
				bind:this={parentContainer}
				style:height="{size}px"
				aria-hidden="true"
			/>
		{:else if thisState}
			{@const { label: category, value } = parsedStates.find((d) => d.state === thisState.full)}
			{@const { label2: category2, value2 } = parsedStates.find((d) => d.state === thisState.full)}
			{@const { label3: category3, value3 } = parsedStates.find((d) => d.state === thisState.full)}
			<div
				on:mouseenter={() =>
					mouseover({ thisState, value, category, value2, category2, value3, category3 })}
				on:mouseleave={() =>
					mouseout({ thisState, value, category, value2, category2, value3, category3 })}
				class="relative overflow-hidden flex flex-col justify-center items-center pointer-events-auto bg-red-light border-solid border-[.5px] border-red rounded-sm hover:bg-yellow hover:border-black"
				style:height="{size}px"
			>
				<p class="text-sm font-display text-black font-bold p-0 m-0 mb-1 text-center text-primary">
					{thisState.postal}
				</p>
				<p class="text-xs font-sans text-black p-0 m-0 text-center text-primary">{category}</p>
				<slot name="tile" />
			</div>
		{:else}
			<div class="pointer-events-none" style:height="{size}px" aria-hidden="true" />
		{/if}
	{/each}
	{#if !!tooltip}
		<Tooltip hidden={!tooltip} {parentContainer}>
			<p class="mt-0 mb-1 text-base font-display font-bold text-black">
				{tooltip.thisState.full}
			</p>
			<p class="my-0 text-sm font-sans">
				{tooltip.category}: <b>{formatValue(tooltip.value)}</b>
			</p>
			{#if tooltip.category2 && tooltip.value2 > 0}
				<p class="my-0 text-sm font-sans">
					{tooltip.category2}: <b>{formatValue(tooltip.value2)}</b>
				</p>
			{/if}
			{#if tooltip.category3 && tooltip.value3 > 0}
				<p class="my-0 text-sm font-sans">
					{tooltip.category3}: <b>{formatValue(tooltip.value3)}</b>
				</p>
			{/if}
		</Tooltip>
	{/if}
</div>
