<script>
	import { LayerCake, Svg, flatten } from 'layercake';
	import { stack } from 'd3-shape';
    import { scaleOrdinal } from 'd3-scale';
    import { format, precisionFixed } from 'd3-format';
    import { timeParse, timeFormat } from 'd3-time-format';

	import AreaStacked from '$lib/components/charts/furniture/AreaStacked.svelte';
	import AxisX from '$lib/components/charts/furniture/AxisX.svelte';
	import AxisY from '$lib/components/charts/furniture/AxisY.svelte';
	import Tooltip from '$lib/components/interactivity/Tooltip.svelte';

    import data from '$lib/data/dollar_searches_year.csv';
    import { filter } from 'd3';

	let tooltip;
	let parentContainer;

    const xKey = 'Year';
    const yKey = [0, 1];
    const zKey = 'key';

    const parseDate = timeParse('%Y');

    const seriesNames = ["$", "$$", "$$$", "$$$$"];
    const seriesColors = ['#398845', '#4BA51C', '#376B8A', '#0B2E4A'];

    /* --------------------------------------------
    * Create a stacked data structure
    */

    let featureCategory = "Restaurants";
    let categories = [...new Set(data.map(d => d.Category))].sort((a, b) => a !== featureCategory);

    const stackData = stack()
        .keys(seriesNames);

    // $: categoryData = data.filter(d => d.Category === currentCategory);
    // $: series = stackData(categoryData);

    const formatPct = (d) => `${Math.round(d * 100)}%`;
</script>

<div class="w-full flex flex-row flex-wrap gap-x-4 gap-y-4" bind:this={parentContainer}>
	{#each categories as category, i}
        {@const isFeatured = i === 0 }
        {@const categoryData = stackData(data.filter(d => d.Category === category))}
        <figure class="m-0 h-full" style="width: {isFeatured ? 100 : 50}%">
            <figcaption class="m-0 mb-2 font-display font-bold text-base text-black">{category}</figcaption>
            <div class="w-full" style="height: {isFeatured ? 400 : 200}px">
                <LayerCake
                    padding={{ top: isFeatured ? 10 : 0, right: 0, bottom: 20, left: isFeatured ? 30 : 0 }}
                    x={d => d.data[xKey]}
                    y={yKey}
                    z={zKey}
                    zScale={scaleOrdinal()}
                    zDomain={seriesNames}
                    zRange={seriesColors}
                    flatData={flatten(categoryData)}
                    data={categoryData}
                >
                    <Svg>
                        <AreaStacked />
                        <g>
                            <AxisX
                                baseline
                                gridlines={false}
                                snapTicks
                                ticks={[2019, 2020, 2021, 2022]}
                            />
                            {#if isFeatured}
                                <AxisY tickMarks={true} gridlines={false} formatTick={formatPct} />
                            {/if}
                        </g>
                    </Svg>
                </LayerCake>
            </div>
        </figure>
    {/each}
	<!-- {#if !!tooltip}
		<Tooltip hidden={!!tooltip} {parentContainer}>
			<p class="my-0 text-base font-sans">
				{tooltip.detail.data.month}'s {tooltip.detail.data.variable} was {format('.2f')(
					tooltip.detail.data.value
				)}
			</p>
		</Tooltip>
	{/if} -->
</div>
