<script>
	import { LayerCake, Svg, Html, flatten } from 'layercake';
	import { timeParse, timeFormat } from 'd3';
	import { stack } from 'd3-shape';
	import { scaleOrdinal } from 'd3-scale';
	import getCategoryName from '$lib/utils/categoryLookup.js';

	import AreaStacked from '$lib/components/charts/furniture/AreaStacked.svelte';
	import AreaLabels from '$lib/components/charts/furniture/AreaLabels.svelte';
	import LegendOrdinal from '$lib/components/charts/furniture/LegendOrdinal.svelte';
	import AxisX from '$lib/components/charts/furniture/AxisX.svelte';
	import AxisY from '$lib/components/charts/furniture/AxisY.svelte';

	import data from '$lib/data/dollar_searches_year.csv';

	let containerWidth = 0;

	const parseDate = timeParse('%m %Y');
	const formatDate = timeFormat('%m %Y');

	const xKey = 'date';
	const yKey = [0, 1];
	const zKey = 'key';

	data.forEach((d) => {
		d[xKey] = parseDate(`${d.Month} ${d.Year}`);
	});

	const seriesNames = ['$$$$', '$$$', '$$', '$'];
	const seriesColors = ['#398845', '#4BA51C', '#376B8A', '#0B2E4A'];

	//to create small multiples
	const categories = [...new Set(data.map((d) => d.Category))];
	const stackData = stack().keys(seriesNames);

	// for area labels
	const dates = [...new Set(data.map((d) => formatDate(d[xKey])))];
	const formatPct = (d) => `${Math.round(d * 100)}%`;

	console.log(dates);
</script>

<div
	class="w-full flex flex-row flex-wrap justify-between gap-x-4 gap-y-4"
	bind:offsetWidth={containerWidth}
>
	<LegendOrdinal
		values={seriesNames.reverse()}
		colors={seriesColors.reverse()}
		title="Percent of searches with pricing filters for businesses marked as"
	/>
	{#each categories as category, i}
		{@const isFeatured = i === 0}
		{@const categoryData = data.filter((d) => d.Category === category)}
		{@const stackedCategoryData = stackData(categoryData)}
		{@const height = isFeatured ? 400 : 260}
		{@const width = isFeatured || containerWidth < 500 ? 100 : 47}
		<figure class="m-0 h-full" style="width: {width}%">
			<figcaption
				class="m-0 mb-2 font-display font-bold text-base text-black"
				class:hidden={isFeatured}
			>
				{getCategoryName(category)}
			</figcaption>
			<div class="w-full" style="height: {height}px">
				<LayerCake
					padding={{ top: isFeatured ? 10 : 0, right: 0, bottom: 20, left: 30 }}
					x={(d) => d.data[xKey]}
					y={yKey}
					z={zKey}
					zScale={scaleOrdinal()}
					zDomain={seriesNames}
					zRange={seriesColors}
					{categoryData}
					flatData={flatten(stackedCategoryData)}
					data={stackedCategoryData}
				>
					<Svg>
						<g>
							<AxisX
								baseline
								gridlines={false}
								snapTicks
								ticks={[
									parseDate('4 2019'),
									parseDate('4 2020'),
									parseDate('4 2021'),
									parseDate('4 2022')
								]}
								formatTick={(tick) => `Q2 ${timeFormat('%Y')(tick)}`}
							/>
							<text
								class="fill-black-light text-xs font-sans"
								style="transform: translateY(90px) rotate(-90deg)"
								x={-height / 2 - 20}
								y={-15}>% Of Searches on Yelp With Pricing Filters</text
							>
							<!-- {#if isFeatured}
                                <AxisY label="of Searches on Yelp" formatTick={formatPct} ticks={[0, .5, 1]} />
                            {/if} -->
						</g>
						<AreaStacked />
						<AreaLabels
							allXVals={dates}
							xValsToShow={isFeatured
								? ['04 2019', '04 2020', '04 2021', '01 2022', '04 2022']
								: ['04 2019', '04 2022']}
							formatLabel={formatPct}
							parseXVal={parseDate}
						/>
					</Svg>
				</LayerCake>
			</div>
		</figure>
	{/each}
</div>
