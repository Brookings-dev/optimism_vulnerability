<script>
	import { LayerCake, Svg, Html, flatten } from 'layercake';
	import { stack } from 'd3-shape';
	import { scaleOrdinal } from 'd3-scale';
	import { format, precisionFixed } from 'd3-format';
	import { timeParse, timeFormat } from 'd3-time-format';

	import AreaStacked from '$lib/components/charts/furniture/AreaStacked.svelte';
	import AreaLabels from '$lib/components/charts/furniture/AreaLabels.svelte';
	import LegendOrdinal from '$lib/components/charts/furniture/LegendOrdinal.svelte';
	import AxisX from '$lib/components/charts/furniture/AxisX.svelte';
	import AxisY from '$lib/components/charts/furniture/AxisY.svelte';
	import Tooltip from '$lib/components/interactivity/Tooltip.svelte';

	import data from '$lib/data/dollar_searches_year.csv';

	let containerWidth = 0;

	let tooltip;
	let parentContainer;

	const xKey = 'Year';
	const yKey = [0, 1];
	const zKey = 'key';

	const seriesNames = ['$$$$', '$$$', '$$', '$'];
	const seriesColors = ['#398845', '#4BA51C', '#376B8A', '#0B2E4A'];

	const featureCategory = 'Overall';
	const categories = [...new Set(data.map((d) => d.Category))];

	const years = [...new Set(data.map((d) => d.Year))];

	const stackData = stack().keys(seriesNames);

	const formatPct = (d) => `${Math.round(d * 100)}%`;
</script>

<div
	class="w-full flex flex-row flex-wrap justify-between gap-x-4 gap-y-4"
	bind:this={parentContainer}
	bind:offsetWidth={containerWidth}
>
	<LegendOrdinal
		values={seriesNames.reverse()}
		colors={seriesColors.reverse()}
		title="Percent of searches with pricing filters for businesses marked as"
	/>
	{#each categories as category, i}
		{@const isFeatured = i === 0}
		{@const categoryData = data.filter((d) => d.Category === category)}
		{@const stackedCategoryData = stackData(categoryData)}
		{@const height = isFeatured ? 400 : 260}
		{@const width = isFeatured || containerWidth < 500 ? 100 : 47}
		<figure class="m-0 h-full" style="width: {width}%">
			<figcaption
				class="m-0 mb-2 font-display font-bold text-base text-black"
				class:hidden={isFeatured}
			>
				{category}
			</figcaption>
			<div class="w-full" style="height: {height}px">
				<LayerCake
					padding={{ top: isFeatured ? 10 : 0, right: 0, bottom: 20, left: 30 }}
					x={(d) => d.data[xKey]}
					y={yKey}
					z={zKey}
					zScale={scaleOrdinal()}
					zDomain={seriesNames}
					zRange={seriesColors}
					{categoryData}
					flatData={flatten(stackedCategoryData)}
					data={stackedCategoryData}
				>
					<Svg>
						<g>
							<AxisX baseline gridlines={false} snapTicks ticks={[2019, 2020, 2021, 2022]} />
							<text
								class="fill-black-light text-xs font-sans"
								style="transform: translateY(90px) rotate(-90deg)"
								x={-height / 2 - 20}
								y={-15}>% Of Searches on Yelp With Pricing Filters</text
							>
							<!-- {#if isFeatured}
                                <AxisY title="of Searches on Yelp" formatTick={formatPct} ticks={[0, .5, 1]} />
                            {/if} -->
						</g>
						<AreaStacked />
						<AreaLabels
							allXVals={years}
							xValsToShow={isFeatured ? years : ['2019', '2022']}
							formatLabel={formatPct}
						/>
					</Svg>
				</LayerCake>
			</div>
		</figure>
	{/each}
	<!-- {#if !!tooltip}
		<Tooltip hidden={!!tooltip} {parentContainer}>
			<p class="my-0 text-base font-sans">
				{tooltip.detail.data.month}'s {tooltip.detail.data.variable} was {format('.2f')(
					tooltip.detail.data.value
				)}
			</p>
		</Tooltip>
	{/if} -->
</div>
