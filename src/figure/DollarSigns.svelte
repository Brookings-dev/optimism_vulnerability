<script>
	import { LayerCake, Svg, flatten } from 'layercake';
	import { timeParse, timeFormat, stack, scaleOrdinal } from 'd3';
	import getCategoryName from '$lib/utils/categoryLookup.js';
	import AreaStacked from '$lib/components/charts/furniture/AreaStacked.svelte';
	import AreaLabels from '$lib/components/charts/furniture/AreaLabels.svelte';
	import LegendOrdinal from '$lib/components/charts/furniture/LegendOrdinal.svelte';
	import AxisX from '$lib/components/charts/furniture/AxisX.svelte';
	import data from '$lib/data/dollar_searches_year.csv';
	import { onMount } from 'svelte';

	let containerWidth = 300;

	const parseDate = timeParse('%m %Y');
	const formatDate = timeFormat('%m %Y');

	const xKey = 'date';
	const yKey = [0, 1];
	const zKey = 'key';

	data.forEach((d) => {
		d[xKey] = parseDate(`${d.Month} ${d.Year}`);
	});

	const seriesNames = ['$$$$', '$$$', '$$', '$'];
	const seriesColors = ['#398845', '#4BA51C', '#376B8A', '#0B2E4A'];

	//to create small multiples
	const categories = [...new Set(data.map((d) => d.Category))];
	const stackData = stack().keys(seriesNames);

	// for area labels
	const dates = [...new Set(data.map((d) => formatDate(d[xKey])))];
	const formatPct = (d) => `${Math.round(d * 100)}%`;

	let mounted;
	onMount(() => (mounted = true));
</script>

<LegendOrdinal
	values={seriesNames.reverse()}
	colors={seriesColors.reverse()}
	title="Percent of searches with pricing filters for businesses marked as"
/>

<div class="w-full grid grid-cols-2 gap-x-12 gap-y-4 mt-2" bind:offsetWidth={containerWidth}>
	{#each categories as category, i}
		{@const isFeatured = i === 0}
		{@const categoryData = data.filter((d) => d.Category === category)}
		{@const stackedCategoryData = stackData(categoryData)}
		{@const height = isFeatured ? 400 : 260}
		<figure class="m-0 h-full w-full col-span-2 md:col-span-1" class:df-feature={isFeatured}>
			<figcaption
				class="m-0 mb-2 font-display font-bold text-base text-black"
				class:hidden={isFeatured}
			>
				{getCategoryName(category)}
			</figcaption>
			<div class="w-full" style="height: {height}px">
				{#if mounted}
					<LayerCake
						padding={{ top: isFeatured ? 10 : 0, right: 0, bottom: 20, left: 30 }}
						x={(d) => d.data[xKey]}
						y={yKey}
						z={zKey}
						zScale={scaleOrdinal()}
						zDomain={seriesNames}
						zRange={seriesColors}
						flatData={flatten(stackedCategoryData)}
						data={stackedCategoryData}
					>
						<Svg>
							<g>
								<AxisX
									baseline
									gridlines={false}
									snapTicks
									ticks={isFeatured && containerWidth > 768
										? [
												parseDate('4 2019'),
												parseDate('4 2020'),
												parseDate('4 2021'),
												parseDate('1 2022'),
												parseDate('4 2022')
										  ]
										: [
												parseDate('4 2019'),
												parseDate('4 2020'),
												parseDate('4 2021'),
												parseDate('4 2022')
										  ]}
									formatTick={(tick) =>
										timeFormat('%m')(tick) === '01'
											? `Q1 '${timeFormat('%y')(tick)}`
											: `Q2 '${timeFormat('%y')(tick)}`}
								/>
								<text
									class="fill-black-light text-sm font-sans"
									style="transform: translateY(90px) rotate(-90deg)"
									x={-height / 2 - 20}
									y={-15}>% Of Searches on Yelp With Pricing Filters</text
								>
							</g>
							<AreaStacked />
							<AreaLabels
								allXVals={dates}
								xValsToShow={isFeatured && containerWidth > 768
									? ['04 2019', '04 2020', '04 2021', '01 2022', '04 2022']
									: ['04 2019', '04 2020', '04 2021', '04 2022']}
								formatLabel={formatPct}
								parseXVal={parseDate}
							/>
						</Svg>
					</LayerCake>
				{/if}
			</div>
		</figure>
	{/each}
</div>

<style lang="postcss">
	.df-feature {
		@apply !col-span-2;
	}
</style>
