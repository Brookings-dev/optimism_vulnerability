<script>
	import { LayerCake, Svg, Html } from 'layercake';
	import { feature } from 'topojson-client';
	import { geoAlbersUsa, geoMercator } from 'd3-geo';
	import { scaleQuantile } from 'd3-scale';
	import Dropdown from '$lib/components/charts/Dropdown.svelte';
	import Select from 'svelte-select';
	import colors from '$lib/utils/colors.json';
	import { extent, format } from 'd3';
	import { onMount } from 'svelte';
	import { selectedSecond, selectedState, selectedCounty } from '$lib/stores.js';
	import { raise } from 'layercake';

	import stateAbbrs from '$lib/data/helpers/stateAbbrs.js';
	import countyAbbrs from '$lib/data/helpers/countyAbbrsFull.js';
	import getCategoryName from '$lib/utils/categoryLookup';

	import Tooltip from '$lib//components/interactivity/Tooltip.html.svelte';
	import LegendThreshold from '$lib/components/charts/furniture/LegendThreshold.svelte';

	import Map from '$lib/components/charts/furniture/Map.svelte';
	import topojson from '$lib/data/cartography/national_misinfo.topojson.json';
	import states from '$lib/data/cartography/states.json';
	import counties from '$lib/data/cartography/counties.json';

	let mounted;
	let evt;
	let hideTooltip = true;
	let colorsBlue = [colors.gray.light, '#BFDFFC', '#5AADF6', '#1E8AD6', '#00649F', '#023147'];

	let containerWidth = 300;
	$: containerHeight = containerWidth * 0.585;
	$: isMobile = containerWidth < 425;

	const projection = geoAlbersUsa;
	const geojson = feature(topojson, topojson.objects.counties);
	const flatData = geojson.features.map((d) => d.properties);

	onMount(async () => {
		mounted = true;
	});

	let formatValue = (d) =>
		$selectedSecond == 'income'
			? '$' + format(',')(format('.2f')(d))
			: format(',')(format('.2f')(d));

	//legend
	let selectedExtentSecond = [];
	$: selectedExtentSecond = extent(
		Object.entries(flatData),
		([key, value]) => +value[$selectedSecond]
	);
	$: colorScaleBlue = scaleQuantile().domain(selectedExtentSecond).range(colorsBlue);

	let scales = [];
	$: scales = colorScaleBlue.quantiles();

	//dropdown states
	let optionsStates = states
		// .filter((d) => d.postal !== 'DC')
		.map((metric) => ({
			label: metric.full,
			value: metric.postal
		}))
		.sort((a, b) => a.label.localeCompare(b.label));

	$: valueState = {
		label: stateAbbrs[$selectedState],
		value: $selectedState
	};

	//dropdown counties

	$: filterCounties = (metrics) => {
		let select = metrics.filter((d) => d.state == $selectedState);
		{
			return select;
		}
	};

	$: valueCounty = {
		label: $selectedCounty == null ? 'select county' : countyAbbrs[$selectedCounty].split(',')[0],
		value: $selectedCounty
	};

	$: countiesByState = filterCounties(counties).map((metric) => ({
		label: metric.county,
		value: metric.fips
	}));

	//dropdown handlers
	const handleState = () => {
		$selectedState = valueState.value;
		$selectedCounty = null;
		valueCounty.label = 'select county';
	};

	$: content = document.getElementsByClassName($selectedCounty);

	let raisedCounty;
	$: window.addEventListener('load', function () {
		raisedCounty = content[0];
		raise(raisedCounty);
	});

	const handleCounty = () => {
		$selectedCounty = valueCounty.value;
		content = document.getElementsByClassName(valueCounty.value);
		raise(content[0]);
	};

	$: title =
		$selectedSecond !== 'None'
			? `${$selectedState} ${getCategoryName($selectedSecond).dropdown.toLowerCase()}`
			: '';

			
</script>

<svelte:window
	on:scroll={() => {
		hideTooltip = true;
	}}
/>
<div
	bind:clientWidth={containerWidth}
	class="grid grid-cols-1 gap-3 justify-items-center my-12 overflow-visible"
>
	{#if $selectedSecond !== 'None'}
		<div>
			<Dropdown title="View data for the state:">
				<Select
					class="m-auto md:mb-6 mb-5 border-b-2 border-b-[{colors.navy
						.DEFAULT}] border-t-transparent border-x-transparent text-[{colors.navy
						.DEFAULT}] font-sans leading-none text-sm bg-transparent"
					items={optionsStates}
					clearable={false}
					bind:value={valueState}
					showChevron={true}
					searchable={false}
					on:change={handleState}
					--width={isMobile ? '250px' : '350px'}
					--border-radius="none"
					--item-hover-bg={colors.gray.light}
					--item-is-active-bg={colors.gray.DEFAULT}
					--chevron-icon-width="20px"
					--selected-item-color={colors.navy.DEFAULT}
				/></Dropdown
			>
		</div>
		<div>
			<Dropdown title="View data for the county:">
				<Select
					class="m-auto md:mb-auto mb-4 border-b-2 border-b-[{colors.navy
						.DEFAULT}] border-t-transparent border-x-transparent text-[{colors.navy
						.DEFAULT}] font-sans bg-transparent"
					items={countiesByState}
					clearable={false}
					bind:value={valueCounty}
					showChevron={true}
					searchable={false}
					on:change={handleCounty}
					--width={isMobile ? '250px' : '350px'}
					--border-radius="none"
					--item-hover-bg={colors.gray.light}
					--item-is-active-bg={colors.gray.DEFAULT}
					--chevron-icon-width="20px"
					--selected-item-color={colors.navy.DEFAULT}
				/></Dropdown
			>
		</div>
	{/if}
	{#if $selectedSecond !== 'None'}
		<div class="mt-5">
			<LegendThreshold colorScale={colorsBlue} {title} {scales} />
		</div>
	{/if}
	<div
		class="cloropleth-div w-full overflow-visible rounded max-w-[500px] mt-5 p-6 bg-slate-200"
		style:height="{containerHeight}px"
		bind:clientWidth={containerWidth}
	>
		{#if mounted}
			<LayerCake data={geojson} {flatData}>
				{#if $selectedSecond !== 'None'}
					<Svg>
						<Map
							{projection}
							stroke={colors.white.DEFAULT}
							on:mousemove={(event) => (evt = hideTooltip = event)}
							on:mouseout={() => (hideTooltip = true)}
						/>
					</Svg>
				{:else if $selectedSecond == 'None'}
					<div
						class="relative top-[35%] text-center text-[{colors.navy
							.DEFAULT}] font-sans leading-none text-md font-bold max-w-[350px] m-auto leading-5"
					>
						Select <i>'U.S. map variable 2'</i> above to view county map
					</div>
				{/if}
				<Html pointerEvents={false}>
					{#if hideTooltip !== true}
						<Tooltip {evt} let:detail>
							{@const tooltipData = { ...detail.props }}
							<div class="flex flex-col gap-1">
								<span class="text-gray"
									>{tooltipData['area_name'] != 'District of Columbia'
										? tooltipData['area_name'].split(',')[0]
										: tooltipData['area_name']}</span
								>
								<span class="text-black"
									>{tooltipData[$selectedSecond] == null
										? 'no data'
										: formatValue(tooltipData[`${$selectedSecond}`])}</span
								>
							</div>
						</Tooltip>
					{/if}
				</Html>
			</LayerCake>
		{/if}
	</div>
</div>
