<script>
	import { LayerCake, Svg } from 'layercake';
	import { feature } from 'topojson-client';
	import { geoAlbersUsa } from 'd3-geo';
	import { scaleThreshold } from 'd3-scale';

	import Map from '$lib/components/charts/furniture/Map.svelte';

	import topojson from '$lib/data/cartography/states_inflation.topojson.json';
	import LegendThreshold from '$lib/components/charts/furniture/LegendThreshold.svelte';
	import Tooltip from '$lib/components/interactivity/Tooltip.svelte';

	let containerWidth = 300;
	$: containerHeight = containerWidth * 0.65;

	const colorScale = [
		'#FFB2B0',
		'#FECECF',
		'#FFE5E5',
		'#D5F6EF',
		'#AFE8DB',
		'#5BC8AF',
		'#05A882',
		'#048264'
	];

	const geojson = feature(topojson, topojson.objects.collection);

	let tooltip;
	let parentContainer;
	const mouseover = ({ detail: { props } }) => (tooltip = props);
	const mouseout = () => (tooltip = undefined);
</script>

<svelte:window on:scroll={mouseout} />

<LegendThreshold
	colors={colorScale}
	start="-30%"
	end="+50%"
	title="Change in mentions of inflationary language in Yelp reviews, Q2 2022 vs. Q2 2021"
/>

<div
	class="w-full overflow-hidden"
	style:height="{containerHeight}px"
	bind:clientWidth={containerWidth}
	bind:this={parentContainer}
>
	<LayerCake
		data={geojson}
		z={['2022 vs 2021']}
		zScale={scaleThreshold()}
		zDomain={[-0.2, -0.1, 0, 0.1, 0.2, 0.3, 0.4]}
		zRange={colorScale}
		{containerHeight}
		flatData={geojson.features.map((d) => d.properties)}
	>
		<Svg>
			<Map projection={geoAlbersUsa} on:mousemove={mouseover} on:mouseout={mouseout} />
		</Svg>
	</LayerCake>
</div>

{#if !!tooltip}
	<Tooltip {parentContainer}>
		<p class="mt-0 mb-1 text-base font-display font-bold text-black">
			{tooltip.name}
		</p>
		<p class="my-0 text-sm font-sans">
			Change since Q2 2021: <b>
				{@html tooltip['2022 vs 2021'] >= 0 ? '&plus;' : ''}{Math.round(
					tooltip['2022 vs 2021'] * 100
				)}&percnt;
			</b>
		</p>
	</Tooltip>
{/if}
