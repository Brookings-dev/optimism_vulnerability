<script>
	import { LayerCake, Svg } from 'layercake';
	import { feature } from 'topojson-client';
	import { geoAlbersUsa } from 'd3-geo';
	import { scaleThreshold } from 'd3-scale';

	import Map from '$lib/components/charts/furniture/Map.svelte';

	import topojson from '$lib/data/cartography/states.topojson.json';
	import states from '$lib/data/cartography/states.json';
	import data from '$lib/data/overall_inflation_state.csv';
	import LegendOrdinal from '$lib/components/charts/furniture/LegendOrdinal.svelte';
	import LegendThreshold from '$lib/components/charts/furniture/LegendThreshold.svelte';

	let containerWidth = 300;
	$: containerHeight = containerWidth * 0.685;

	const geojson = feature(topojson, topojson.objects.collection);
	const projection = geoAlbersUsa;

	let evt;
	let hideTooltip = true;

	const flatData = geojson.features.map((d) => d.properties);

	const dataLookup = (state) => {
		const postal = states.find((d) => d.full === state.name).postal;
		return data.find((d) => d.State === postal)['2022 vs 2021'];
	};
	const colorScale = [
		'#FFB2B0',
		'#FECECF',
		'#FFE5E5',
		'#D5F6EF',
		'#AFE8DB',
		'#5BC8AF',
		'#05A882',
		'#048264'
	];
	const domain = [-0.2, -0.1, 0, 0.1, 0.2, 0.3, 0.4];
</script>

<div
	class="w-full overflow-hidden"
	style:height="{containerHeight}px"
	bind:clientWidth={containerWidth}
>
	<LegendThreshold
		colors={colorScale}
		start="-30%"
		end="+50%"
		title="Change in mentions of inflationary language* in Yelp reviews, Q2 2022 vs. Q2 2021"
	/>
	<LayerCake
		data={geojson}
		z={(d) => dataLookup(d)}
		zScale={scaleThreshold()}
		zDomain={domain}
		zRange={colorScale}
		{flatData}
	>
		<Svg>
			<Map
				{projection}
				on:mousemove={(event) => (evt = hideTooltip = event)}
				on:mouseout={() => (hideTooltip = true)}
			/>
		</Svg>
	</LayerCake>
</div>
