<script>
	import { LayerCake, Svg, Html } from 'layercake';
	import { feature } from 'topojson-client';
	import { geoAlbersUsa } from 'd3-geo';
	import { group } from 'd3';
	import Dropdown from '$lib/components/charts/Dropdown.svelte';
	import Select from 'svelte-select';
	import colors from '$lib/utils/colors.json';
	import { onMount } from 'svelte';
	import { selectedSecond, selectedState, selectedCounty } from '$lib/stores.js';
	import Tooltip from '$lib//components/interactivity/Tooltip.html.svelte';

	let mounted;

	import Map from '$lib/components/charts/furniture/Map.svelte';
	import topojson from '$lib/data/cartography/national.topojson.json';
	import states from '$lib/data/cartography/states.json';
	import counties from '$lib/data/cartography/counties.json';

	let containerWidth = 300;
	$: containerHeight = containerWidth * 0.585;

	const projection = geoAlbersUsa;

	const geojson = feature(topojson, topojson.objects.counties);

	onMount(async () => {
		mounted = true;
	});

	let evt;
	let hideTooltip = true;

	const flatData = geojson.features.map((d) => d.properties);

	let optionsStates = states
		.map((metric) => ({
			label: metric.full,
			value: metric.postal
		}))
		.sort();

	let valueState = {
		label: $selectedState,
		value: $selectedState
	};

	//need to group county by state for county options with .groupby()
	//need to remove counties that do not have data (Puerto Rico, etc.)

	$: countiesByState = counties.map((metric) => metric.postal == $selectedState && metric.county);
	$: console.log(countiesByState);

	let optionsCounties = counties.map((metric) => ({
		label: metric.county,
		value: metric.fips
	}));

	let valueCounty = {
		label: $selectedCounty,
		value: $selectedCounty
	};

	let handle = () => {
		$selectedState = valueState.value;
		$selectedCounty = valueCounty.value;
	};
</script>

<div class="grid md:grid-cols-1 grid-cols-1 gap-10 justify-items-center my-12">
	<div>
		<Dropdown title="View data for the state:">
			<Select
				class="m-auto md:mb-auto mb-5 border-b-2 border-b-[{colors.gray
					.dark}] border-t-transparent border-x-transparent text-[{colors.gray.dark}] font-sans"
				items={optionsStates}
				clearable={false}
				bind:value={valueState}
				showChevron={true}
				searchable={false}
				on:change={handle}
				--width="300px"
				--border-radius="none"
				--item-hover-bg={colors.gray.light}
				--item-is-active-bg={colors.gray.DEFAULT}
				--chevron-icon-width="20px"
				--selected-item-color={colors.gray.dark}
			/></Dropdown
		>
		<Dropdown title="View data for the county:">
			<Select
				class="m-auto md:mb-auto mb-5 border-b-2 border-b-[{colors.gray
					.dark}] border-t-transparent border-x-transparent text-[{colors.gray.dark}] font-sans"
				items={optionsCounties}
				clearable={false}
				bind:value={valueCounty}
				showChevron={true}
				searchable={false}
				on:change={handle}
				--width="300px"
				--border-radius="none"
				--item-hover-bg={colors.gray.light}
				--item-is-active-bg={colors.gray.DEFAULT}
				--chevron-icon-width="20px"
				--selected-item-color={colors.gray.dark}
			/></Dropdown
		>
	</div>
	<div
		class="w-full overflow-hidden"
		style:height="{containerHeight}px"
		bind:clientWidth={containerWidth}
	>
		{#if mounted}
			<LayerCake data={geojson} {flatData}>
				<Svg>
					<Map
						{projection}
						on:mousemove={(event) => (evt = hideTooltip = event)}
						on:mouseout={() => (hideTooltip = true)}
					/>
				</Svg>
				<Html pointerEvents={false}>
					{#if hideTooltip !== true}
						<Tooltip {evt} let:detail>
							{@const tooltipData = { ...detail.props }}
							<div class="row">
								<span class="text-black">{tooltipData[`${$selectedSecond}`]}</span>
							</div>
						</Tooltip>
					{/if}
				</Html>
			</LayerCake>
		{/if}
	</div>
</div>
