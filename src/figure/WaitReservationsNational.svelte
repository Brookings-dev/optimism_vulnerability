<script>
	import WaitResData from '$lib/data/wait_reservations_months.csv';
	import { LayerCake, Svg } from 'layercake';
	// import weather from '$lib/data/weather.csv';

	import { scaleTime, timeParse, groups, format, timeFormat, max } from 'd3';
	// import { apmonth } from 'journalize';

	import Line from '$lib/components/charts/furniture/Line.svelte';
	import Circle from '$lib/components/charts/furniture/Circle.svelte';
	import Voronoi from '$lib/components/charts/furniture/Voronoi.svelte';
	import AxisX from '$lib/components/charts/furniture/AxisX.svelte';
	import AxisY from '$lib/components/charts/furniture/AxisY.svelte';
	import Tooltip from '$lib/components/interactivity/Tooltip.svelte';

	let containerWidth = 0;
	$: isMobile = containerWidth < 720;

	$: height = isMobile ? '300px' : '400px';
	$: numCols = isMobile ? 'grid-cols-1' : 'grid-cols-2';

	let tooltip;
	let parentContainer;

	const yAccessor = (d) => d.Value;
	const grouped = groups(WaitResData, (d) => d.Type);
	const formatTime = timeFormat('%Y');
	const titles = {
		ReservationTimes: {
			metric: 'Days',
			title: 'Average Days Elapsed Before Restaurant Reservation*',
			description: 'Average Days Elapsed Before Restaurant Reservation',
			stroke: 'stroke-red',
			fill: 'fill-red'
		},
		WaitTimes: {
			metric: 'Minutes',
			title: 'Median Restaurant Wait Time in Minutes',
			description: 'Median Restaurant Wait Time',
			stroke: 'stroke-blue-dark',
			fill: 'fill-blue-dark'
		}
	};
</script>

<div
	class="grid {numCols} gap-y-10 gap-x-16 relative"
	bind:this={parentContainer}
	bind:offsetWidth={containerWidth}
>
	{#each grouped as [type, data]}
		{@const { title, fill, stroke, metric } = titles[type]}
		<!-- {#each Object.entries(titles) as [label, { Title, Stroke, Fill }]} -->
		<figure class="m-0 p-0">
			<figcaption class="m-0 font-sans font-bold text-md text-black text-center">
				{title}
			</figcaption>
			<figcaption class="m-0 font-sans text-md text-gray text-center">
				January 2018 - June 2022
			</figcaption>
			<div class="w-full" style:height>
				<LayerCake
					padding={{ left: 0, bottom: 20, right: 0, top: 20 }}
					x={(d) => timeParse('%B %Y')(d.Month_Year)}
					y="Value"
					xScale={scaleTime()}
					yDomain={[0, max(data, yAccessor)]}
					{data}
				>
					<Svg>
						<g>
							<AxisX
								baseline
								gridlines={false}
								snapTicks
								ticks={[
									timeParse('%Y')('2018'),
									timeParse('%Y')('2019'),
									timeParse('%Y')('2020'),
									timeParse('%Y')('2021'),
									timeParse('%Y')('2022')
								]}
								formatTick={(tick) => formatTime(tick)}
							/>
							<AxisY ticks="4" label={metric} />
						</g>

						<Line
							hasArea
							class={stroke}
							areaClass={`${fill} opacity-20`}
							strokeWidth="3"
							strokeLineCap="round"
						/>

						{#if !!tooltip}
							{#if tooltip.detail.data.Type === type}
								<Circle data={tooltip.detail.data} r="6" class="{fill} stroke-black stroke-[1px]" />
							{/if}
						{/if}

						<Voronoi
							on:mouseover={(e) => (tooltip = e)}
							on:mouseout={() => (tooltip = undefined)}
						/>
					</Svg>
				</LayerCake>
			</div>
		</figure>
	{/each}
	<!-- {/each} -->
	{#if !!tooltip}
		<Tooltip hidden={!tooltip} {parentContainer}>
			{@const { description, metric } = titles[tooltip.detail.data.Type]}
			<p class="mt-0 mb-2 text-base font-display font-bold text-black">
				{tooltip.detail.data.Month_Year}
			</p>
			<p class="my-0 text-sm font-sans text-black">
				{description}:
				<span class="font-bold whitespace-nowrap"
					>{format('.2f')(tooltip.detail.data.Value)}
					{metric}</span
				>
			</p>
		</Tooltip>
	{/if}
</div>
