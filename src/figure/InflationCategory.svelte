<script>
	import { LayerCake, Svg } from 'layercake';
	import { scaleTime, timeParse, groups, min, max, timeFormat } from 'd3';
	import getCategoryName from '$lib/utils/categoryLookup.js';

	import Line from '$lib/components/charts/furniture/Line.svelte';
	import Circle from '$lib/components/charts/furniture/Circle.svelte';
	import Voronoi from '$lib/components/charts/furniture/Voronoi.svelte';
	import AxisX from '$lib/components/charts/furniture/AxisX.svelte';
	import AxisY from '$lib/components/charts/furniture/AxisY.svelte';
	import Tooltip from '$lib/components/interactivity/Tooltip.svelte';

	import data from '$lib/data/inflation_quarter.csv';

	export let height = '200px';
	let containerWidth = 0;
	$: numCols = containerWidth < 720 ? 2 : 3;

	let categories = [
		'restaurants',
		'food',
		'arts',
		'localservices',
		'shopping',
		'nightlife',
		'auto',
		'eventservices',
		'hotelstravel',
		'homeservices',
		'active',
		'beautysvc'
	];

	let categoryData = data
		.filter((d) => categories.indexOf(d.Category) > -1)
		.map((d) => {
			d.date = `${d.Month} ${d.Year}`;
			d.name = getCategoryName(d.Category);
			return { ...d };
		});

	categoryData.sort((a, b) => {
		return categories.indexOf(a.Category) - categories.indexOf(b.Category);
	});

	const minValue = min(categoryData, (d) => +d['Mentions_per_Million']);
	const maxValue = max(categoryData, (d) => +d['Mentions_per_Million']);

	const grouped = groups(categoryData, (d) => d.name);

	let tooltip;
	let parentContainer;

	const getChangeSinceStart = (tooltipData) => {
		const startData = categoryData.find((d) => d.date === '4 2020' && d.name === tooltipData.name);
		const changeSinceStart =
			(+tooltipData['Mentions_per_Million'] - +startData['Mentions_per_Million']) /
			+startData['Mentions_per_Million'];
		return `${changeSinceStart >= 0 ? '+' : ''}${Math.round(changeSinceStart * 100)}%`;
	};
</script>

<div
	class="grid grid-cols-2 md:grid-cols-3 gap-12"
	bind:this={parentContainer}
	bind:offsetWidth={containerWidth}
>
	{#each grouped as [category, data], i}
		<figure class="m-0 relative">
			<figcaption class="m-0 font-display font-bold text-sm sm:text-base text-black">
				{category}
			</figcaption>
			<div class="w-full layercake-wrapper" style:height>
				<LayerCake
					padding={{ left: 0, bottom: 20, right: 0, top: 20 }}
					x={(d) => timeParse('%m %Y')(d.date)}
					y="Mentions_per_Million"
					xScale={scaleTime()}
					yDomain={[minValue, maxValue]}
					{data}
				>
					<Svg>
						<g>
							<AxisX
								gridlines={false}
								snapTicks
								ticks={[
									timeParse('%m %Y')('4 2020'),
									timeParse('%m %Y')('4 2021'),
									timeParse('%m %Y')('4 2022')
								]}
								formatTick={(tick) => `Q2 ${timeFormat('%Y')(tick)}`}
							/>
							<AxisY
								formatTick={() => ''}
								ticks={[minValue, (minValue + maxValue) / 2, maxValue]}
								label={i % numCols === 0 ? 'Review Mentions Per Million Words' : ''}
							/>
						</g>

						<Line
							class="stroke-red"
							areaClass="fill-red opacity-20"
							strokeWidth="3"
							strokeLineCap="round"
						/>

						{#each data as circle}
							<Circle data={circle} class="fill-red" />
						{/each}

						{#if !!tooltip}
							{#if tooltip.detail.data.name === category}
								<Circle
									data={tooltip.detail.data}
									r="6"
									class="fill-red stroke-black stroke-[1px]"
								/>
							{/if}
						{/if}

						<Voronoi
							on:mouseover={(e) => (tooltip = e)}
							on:mouseout={() => (tooltip = undefined)}
						/>
					</Svg>
				</LayerCake>
			</div>
		</figure>
	{/each}
	{#if !!tooltip}
		<Tooltip hidden={!tooltip} {parentContainer}>
			<p class="mt-0 mb-2 text-base font-display font-bold text-black">
				{tooltip.detail.data.Quarter}
				{tooltip.detail.data.Year}
			</p>
			<p class="my-0 text-sm font-sans">
				Change since Q2 2020: <b>{getChangeSinceStart(tooltip.detail.data)}</b>
			</p>
		</Tooltip>
	{/if}
</div>
