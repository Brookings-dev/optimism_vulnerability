<script>
	import { LayerCake, Svg } from 'layercake';
	import { feature } from 'topojson-client';
	import { geoAlbersUsa } from 'd3-geo';
	import { scaleThreshold } from 'd3-scale';

	import Map from '$lib/components/charts/furniture/Map.svelte';

	import topojson from '$lib/data/cartography/states.topojson.json';
	import states from '$lib/data/cartography/states.json';
	import data from '$lib/data/real_estate_state.csv';

	let containerWidth = 300;
	$: containerHeight = containerWidth * 0.585;

	const geojson = feature(topojson, topojson.objects.collection);
	const projection = geoAlbersUsa;

	let evt;
	let hideTooltip = true;

	const flatData = geojson.features.map((d) => d.properties);

	const dataLookup = (state) => {
		const postal = states.find((d) => d.full === state.name).postal;
		return data.find((d) => d.State === postal)['2022_vs_2021'];
	};
</script>

<div
	class="w-full overflow-hidden"
	style:height="{containerHeight}px"
	bind:clientWidth={containerWidth}
>
	<LayerCake
		data={geojson}
		z={(d) => dataLookup(d)}
		zScale={scaleThreshold()}
		zDomain={[-0.3, -0.2, -0.1, 0, 0.1, 0.2, 0.3]}
		zRange={[
			'#D56259',
			'#E88785',
			'#F9B1B2',
			'#FEE6E6',
			'#D5F6EF',
			'#AFE8DB',
			'#5BC8AF',
			'#05A882'
		]}
		{flatData}
	>
		<Svg>
			<Map
				{projection}
				on:mousemove={(event) => (evt = hideTooltip = event)}
				on:mouseout={() => (hideTooltip = true)}
			/>
		</Svg>
	</LayerCake>
</div>
